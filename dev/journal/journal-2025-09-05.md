# 📅 Journal — 2025-09-05

## ✅ Completed: `S1-T13: Supabase Integration`

**Subtasks Executed:**

- 🔹 `S1-T13A:` Installed `@supabase/supabase-js` in `@basalang/shared`
- 🔹 `S1-T13B:` Created `supabase.ts` with `createClient(...)`
- 🔹 `S1-T13C:` Exported `supabase` from shared package index
- 🔹 `S1-T13D:` Implemented test page at `/test-supabase` rendering query results
- 🔹 `S1-T13E:` Verified access via `curl`, browser, and ngrok
- 🔹 `S1-T13F:` Diagnosed and bypassed Hetzner container DNS/firewall restrictions
- 🔹 `S1-T13G:` Finalized commit/tag/push

**Verification:** ✅ Passed
- Ngrok tunnel confirmed working and Supabase config queried.
- Result properly rendered as formatted JSON block in browser.

**Tag:** `S1-T13D`

## ✅ Completed: `S1-T14: ASR Scaffold & Server Util`

**What was built:**
- `/session` page scaffolded with protected Clerk layout
- Waveform placeholder + "Send Dummy Audio Chunk" button
- `@basalang/shared/asr.ts` created with ASR constants and types
- API route `/api/asr/stream` implemented to receive POSTed audio data

**Validation Steps:**
- Ran dev server with `pnpm --filter @basalang/web dev`
- Exposed via `ngrok http 3000`
- Opened `/session` on public URL
- Clicked button → backend logs showed 8000 bytes received
- Browser DevTools confirmed JSON response handled correctly

**Result:**
✅ End-to-end confirmed via live test  
✅ Task complete and production-verified

**Tag:** `S1-T14`

---

## SNAP-002 — Immutable Environment Snapshot Created

**Timestamp:** 2025-09-05 21:44:44 UTC  
**File:** `/workspaces/basalang/dev/snapshots/snapshot_2025-09-05_21-44-44.tar.gz`  
**SHA256:** `4ae34f4736893b4178736c490d0a068232d7eb9930448743f1ca4c0a22173b15`

**Scope:**
- Full workspace minus `.git`, `node_modules`, and prior snapshots
- Captures all current code, configuration, and `.env.local`

**Purpose:**  
This snapshot serves as the **official rollback anchor** prior to initiating **Phase 2: Session Listener & Audio Recorder**.

✅ Snapshot integrity confirmed
✅ Stored in audit-traceable directory
✅ Rollback path fully operational

---

## SNAP-003 — Verified Immutable Snapshot

**Timestamp:** 2025-09-05 22:01:39 UTC  
**File:** `/workspaces/basalang/dev/snapshots/snapshot_2025-09-05_22-01-39.tar.gz`  
**SHA256:** `6478553761ac25061b0408718a5de7d6c5d7511dabf48b0f87610ccd70b355cf`  
**Integrity Check:** ✅ Passed via `sha256sum -c`

**Notes:**
- This snapshot includes the full workspace (excludes `.git`, `node_modules`, and `/dev/snapshots`)
- Script auto-verification patch confirmed working
- Environment is now safely locked prior to `S2-T01A`

**Purpose:**  
Immutable rollback anchor prior to audio mic pipeline development (Phase 2)

## ✅ S2-T01A: Scaffold MicTest Component and Mount to `/session`

**Branch:** `phase/2`  
**Tag:** `S2-T01A`  
**Date:** 2025-09-05  
**Developer:** Daniel Kyle  
**Environment:** Remote SSH + DevContainer  
**Status:** Complete

---

### 📌 Summary

- Created `MicTest.tsx` component to simulate mic permission checks.
- Rendered only during `NODE_ENV=development` mode.
- Mounted it to the `/session` page under `<SignedIn>`.
- Path aliases (`@/components`) enabled via updated `tsconfig.json`.
- Verified functionality via public URL:  
  [`https://fbedfaa922d2.ngrok-free.app/session`](https://fbedfaa922d2.ngrok-free.app/session)

---

### 🔧 Engineering Details

- Used `useState` to track mic status: `idle`, `requesting`, `granted`, `denied`
- Called `navigator.mediaDevices.getUserMedia({ audio: true })`
- Added button to request mic permission in-browser
- Patched import path resolution (`NodeNext`, `paths`, `baseUrl`)
- Final code fully TypeScript + ESLint compliant
- Verified in browser and terminal logs

---

### 🔐 Safeguards

- Snapshot taken: `snapshot_2025-09-05_22-01-39.tar.gz`
- Rollback system tested in isolated `/tmp` staging dir

## ✅ S2-T01B: Auto Mic Permissions + Waveform Scaffold

**Branch:** `phase/2`  
**Tag:** `S2-T01B`  
**Date:** 2025-09-05  
**Developer:** Daniel Kyle  
**Environment:** Remote SSH + DevContainer  
**Status:** Complete

---

### 📌 Summary

- On mount, `MicTest` now auto-requests microphone access
- Displays status: `idle` → `requesting` → `granted` or `denied`
- Cleanly handles permission denials and revocations
- Introduced a `<canvas>` waveform placeholder with styling
- Verified via live ngrok preview:
  [`https://fbedfaa922d2.ngrok-free.app/session`](https://fbedfaa922d2.ngrok-free.app/session)

---

### 🔧 Engineering Details

- Used `useEffect()` for auto mic capture
- Stored media stream in `ref` and cleaned on unmount
- Canvas added but waveform animation pending (future task)
- Preserved strict TS types and dev-only visibility

---

## ✅ S2-T01C: AudioBuffer Wiring from Mic

**Branch:** `phase/2`  
**Tag:** `S2-T01C`  
**Date:** 2025-09-05  
**Developer:** Daniel Kyle  
**Environment:** Remote SSH + DevContainer  
**Status:** Complete

---

### 📌 Summary

- Connected live mic input to `AudioContext`
- Created `ScriptProcessorNode` to capture 4096-sample buffers
- Console logs verify real-time audio stream data
- Laid groundwork for waveform animation and voice filtering

---

### 🔧 Engineering Details

- Mic stream piped to `MediaStreamSource` → `ScriptProcessorNode`
- `onaudioprocess` emits channel data logs
- Audio graph connected to `AudioContext.destination` to stay alive
- All tracks, processor, and context cleaned up on unmount

---

## ✅ S2-T01D: Live Waveform Animation from Mic Input

**Branch:** `phase/2`  
**Tag:** `S2-T01D`  
**Date:** 2025-09-05  
**Developer:** Daniel Kyle  
**Status:** Complete

---

### 📌 Summary

- Visualized real-time mic audio in a `<canvas>`
- Sampled amplitude values from `AudioBuffer`
- Used `requestAnimationFrame()` to render 60fps waveform
- Output verified via `ngrok` on `/session`

---

### 🔧 Implementation Details

- Added `canvasRef` to `MicTest.tsx`
- Used `ScriptProcessorNode` for audio buffer streaming
- Normalized amplitude to canvas height
- Animated waveform line drawing with `lineTo(x, y)`
- Cleaned up on unmount: audio + animation

### ✅ S2-T01E: Voice Activity Detection (VAD)

**What was built:**
- Integrated VAD using Root Mean Square (RMS) volume thresholding.
- Added VAD status state (`speaking` / `silent`) to MicTest component.
- Color-coded waveform: blue when silent, green when speaking.
- Live feedback text + console logs enabled for dev-only monitoring.

**Test Results:**
- Confirmed accurate transition between speaking/silent based on actual mic input.
- Canvas rendering and state toggling are responsive and accurate.

**Command Log:**
- Mic audio analyzed via `onaudioprocess → Float32Array → RMS calculation`
- Threshold set to `0.02` for VAD detection.
- Logs appear every transition event (no flooding).

**Dev Status:** Stable in browser, verified via `/session` through ngrok tunnel.

---

### ✅ S2-T01F: Capture Voiceprint

- Added `🔐 Capture Voiceprint` button to `MicTest`
- Samples ~1 second of mic input and computes a normalized fingerprint
- Logs result to dev console
- Stored fingerprint in `voiceprintRef` for future speaker isolation logic

Tested successfully via ngrok session at `/session`. 
Confirmed console output and buffer shape.

---
